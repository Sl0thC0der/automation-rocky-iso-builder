# CLAUDE.md

## Context (from chat)

Goal: Build an easy-to-deploy Rocky Linux installer ISO for a spare hardware machine that comes up ready to use for **remote Docker testing**.

Key requirements:
- Prefer **Option 1**: local install via ISO/USB (not PXE).
- Automate **OS install** + **container runtime install**.
- Install **both**:
  - Podman (from Rocky repos)
  - Docker Engine + Compose plugin (from Docker official RHEL repo)
- Keep things "always newest" in the sense of:
  - `dnf --refresh update/upgrade` for Rocky packages
  - Docker Engine packages sourced from Docker's repo (newest available there)
- Remote usage: SSH enabled by default (VPN like Tailscale discussed as recommended, but not mandatory in repo).

Important coexistence rule:
- **Do not install `podman-docker`** when also installing real Docker Engine, to avoid confusing socket/CLI collisions.
- Docker uses `/var/run/docker.sock`.
- Podman socket (optional) uses `/run/podman/podman.sock` via `podman.socket`.

Preferred workflow:
- Use `docker ...` for Docker Engine.
- Use `podman ...` for Podman.
- Optionally allow Docker CLI to target Podman via Docker contexts if `podman.socket` is enabled:
  - `docker context create podman --docker "host=unix:///run/podman/podman.sock"`
  - `docker context use podman`

## Repo purpose

This repo exists to:
1) Build a **custom Rocky ISO** with an embedded Kickstart (`ks.cfg`) using `mkksiso`.
2) Produce `Rocky-ks.iso` which can be written to USB and installed unattended on bare metal.
3) After install, the machine reboots with:
   - SSH enabled
   - Podman installed
   - Docker Engine + Compose installed and running
   - Optional: Podman API socket enabled
   - Optional: user added to `docker` group (requires re-login)

## Implementation approach

### ISO customization
- Use a Docker container to run `mkksiso` (Lorax).
- Build container image (Rocky-based) that installs:
  - `lorax` (provides `mkksiso`)
  - `xorriso`, `isomd5sum`, `curl`, `ca-certificates`

Expected command pattern:
- `mkksiso --ks /work/ks.cfg /work/input.iso /work/output.iso`

The container is run with a bind mount of the working directory and typically `--privileged`.

### Kickstart behavior (high level)
- Minimal Rocky install (text mode).
- DHCP networking (can be changed later).
- Enable `sshd`, allow SSH in firewall.
- SELinux enforcing.
- Partitioning: wipe disk + autopart (safe defaults for a lab box).
- `%post`:
  - `dnf -y --refresh update`
  - install `podman`
  - ensure `podman-docker` is removed/not installed
  - add Docker repo: `https://download.docker.com/linux/rhel/docker-ce.repo`
  - install: `docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin`
  - enable/start Docker service
  - optionally enable `podman.socket`
  - add default user to `docker` group

## Usage (expected)
- Place Rocky ISO in repo (commonly as `Rocky.iso`) and Kickstart as `ks.cfg`.
- Run build script to generate `Rocky-ks.iso`.
- Write ISO to USB and boot target machine.
- Post-install: SSH into machine and test:
  - `docker run --rm hello-world`
  - `podman run --rm hello-world`
  - `docker compose version`

## Notes / caveats
- "Always newest" for Podman means newest available in Rocky repos (Rocky follows RHEL cadence).
- Docker "newest" comes from Docker's official repo.
- Do **not** expose Docker's TCP API (2375) publicly.
- Published container ports should ideally be accessed over VPN or behind firewall rules.

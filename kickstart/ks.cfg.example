#version=RHEL10
# Unattended Rocky Linux install + Docker Engine + Podman
#
# WARNING: This wipes ALL detected disks. OS installs on the first disk only.
# Review carefully before use.

cmdline
reboot
eula --agreed
# Installation source: auto-detected by dracut via inst.stage2=hd:LABEL=... on kernel cmdline.
# Do NOT add 'cdrom' or 'inst.repo=cdrom' — both only scan optical /dev/sr* drives, not USB.
lang en_US.UTF-8
keyboard --xlayouts='ch(de)'
timezone Europe/Zurich --utc

# Networking (DHCP) + SSH
network --bootproto=dhcp --device=link --activate --onboot=on
services --enabled=sshd
firewall --disabled
selinux --enforcing

# Accounts
# Root locked, adminlocal gets a temporary password that must be changed at first login
rootpw --lock
user --name=adminlocal --groups=wheel --password=changeme --plaintext

# Disk: dynamic partitioning (generated by %pre, supports multiple disks)
%include /tmp/part-include

%packages
@^server-product-environment
chrony
curl
ca-certificates
dnf-plugins-core
openssh-server
net-tools
wget
bash-completion
net-snmp
net-snmp-utils
%end

%post --nochroot --interpreter=/bin/bash --log=/mnt/sysimage/root/ks-prebake.log
# Detect pre-baked RPM repo on the ISO and create a local repo config.
# Must run --nochroot because ISO mounts are not visible inside the chroot.

PREBAKE_REPO=""
# Modern Anaconda path (RHEL 9+ / Rocky 10)
for d in /run/install/sources/mount-*-cdrom; do
    if [ -d "$d/prebaked-rpms/repodata" ]; then
        PREBAKE_REPO="$d/prebaked-rpms"
        break
    fi
done
# Fallback: legacy dracut path
if [ -z "$PREBAKE_REPO" ] && [ -d "/run/install/repo/prebaked-rpms/repodata" ]; then
    PREBAKE_REPO="/run/install/repo/prebaked-rpms"
fi

if [ -n "$PREBAKE_REPO" ]; then
    echo "Found pre-baked RPM repo at ${PREBAKE_REPO}"
    # Bind-mount the repo into the chroot so the chrooted %post can access it
    mkdir -p /mnt/sysimage/tmp/prebaked-rpms
    mount --bind "$PREBAKE_REPO" /mnt/sysimage/tmp/prebaked-rpms
    cat > /mnt/sysimage/etc/yum.repos.d/prebaked-local.repo << LOCALREPO
[prebaked-local]
name=Pre-baked Local RPMs
baseurl=file:///tmp/prebaked-rpms
enabled=1
gpgcheck=0
priority=1
cost=100
LOCALREPO
    echo "Local repo bind-mounted at /mnt/sysimage/tmp/prebaked-rpms"
    echo "Repo config written — dnf will prefer cached packages"
else
    echo "No pre-baked RPM repo found — all packages will be downloaded"
fi
%end

%post --interpreter=/bin/bash --log=/root/ks-post.log
# No set -euo pipefail: non-critical failures must not abort the entire post-install

# ============================================================
# CRITICAL: User setup, updates, and core config (run first)
# ============================================================

# Full system update and upgrade
dnf -y --refresh update || true
dnf -y --refresh upgrade || true

# Configure NTP to use Swiss METAS time server
sed -i '/^pool /d' /etc/chrony.conf
sed -i '/^server /d' /etc/chrony.conf
echo 'server ntp.metas.ch iburst' >> /etc/chrony.conf
systemctl enable chronyd || true

# Set hostname from DHCP (if DHCP server provides option 12, NM will use it)
mkdir -p /etc/NetworkManager/conf.d
cat > /etc/NetworkManager/conf.d/hostname.conf << 'NMHOST'
[main]
hostname-mode=dhcp
NMHOST

# ============================================================
# PACKAGES: Install additional software
# ============================================================

# Enable CRB (CodeReady Builder) - required by EPEL dependencies
# Try DNF5 syntax first, fall back to DNF4
dnf config-manager setopt crb.enabled=1 2>/dev/null || dnf config-manager --set-enabled crb 2>/dev/null || true

# EPEL repo (needed for fail2ban and other extras)
dnf -y install epel-release || true

# Install firmware and drivers
dnf -y install linux-firmware dracut-config-generic || true
dnf -y install pciutils usbutils lshw || true
dnf -y groupinstall "Hardware Monitoring Utilities" || true

# ============================================================
# CPU/APU DETECTION: Auto-configure AMD or Intel graphics
# ============================================================

CPU_VENDOR=$(lscpu | grep 'Vendor ID:' | awk '{print $3}')
echo "Detected CPU vendor: $CPU_VENDOR"

if [ "$CPU_VENDOR" = "AuthenticAMD" ]; then
    echo "=== Configuring AMD CPU/APU ==="

    # Install AMD GPU acceleration packages
    dnf -y install \
        mesa-vulkan-drivers \
        vulkan-loader \
        libvdpau \
        libdrm || true

    # Force amdgpu module to load at boot (creates /dev/dri/renderD* nodes)
    echo "amdgpu" > /etc/modules-load.d/amdgpu.conf

    # Blacklist simple-framebuffer so amdgpu binds to GPU properly
    echo "blacklist simple-framebuffer" > /etc/modprobe.d/blacklist-simplefb.conf

    echo "AMD GPU drivers configured (amdgpu, Vulkan, VDPAU)"

elif [ "$CPU_VENDOR" = "GenuineIntel" ]; then
    echo "=== Configuring Intel CPU/APU ==="

    # Install Intel GPU acceleration packages
    dnf -y install \
        mesa-vulkan-drivers \
        vulkan-loader \
        libva \
        libvdpau \
        libdrm || true

    # Intel-specific media drivers (for hardware video encoding/decoding)
    # Try to install intel-media-driver (newer) and fall back to libva-intel-driver (legacy)
    dnf -y install intel-media-driver || dnf -y install libva-intel-driver || true

    # Force i915 module to load at boot (Intel integrated graphics)
    echo "i915" > /etc/modules-load.d/i915.conf

    # Enable GuC/HuC firmware for newer Intel GPUs (improves performance)
    echo "options i915 enable_guc=3" > /etc/modprobe.d/i915.conf

    # Blacklist simple-framebuffer so i915 binds properly
    echo "blacklist simple-framebuffer" > /etc/modprobe.d/blacklist-simplefb.conf

    echo "Intel GPU drivers configured (i915, Vulkan, VA-API)"

else
    echo "Unknown CPU vendor: $CPU_VENDOR (skipping CPU-specific GPU auto-config)"
fi

# ============================================================
# NVIDIA GPU DETECTION: Check for discrete NVIDIA cards
# ============================================================

NVIDIA_GPU=$(lspci | grep -i 'vga.*nvidia\|3d.*nvidia\|display.*nvidia' || true)
if [ -n "$NVIDIA_GPU" ]; then
    echo "=== NVIDIA GPU detected ==="
    echo "$NVIDIA_GPU"

    # Install base Mesa drivers (for fallback/hybrid graphics)
    dnf -y install \
        mesa-vulkan-drivers \
        vulkan-loader \
        libvdpau \
        libdrm || true

    # Add RPMFusion repository (contains NVIDIA proprietary drivers)
    echo "Adding RPMFusion repositories for NVIDIA drivers..."
    dnf -y install https://download1.rpmfusion.org/free/el/rpmfusion-free-release-10.noarch.rpm || true
    dnf -y install https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-10.noarch.rpm || true

    # Install NVIDIA proprietary driver (auto-detects GPU model and installs correct version)
    echo "Installing NVIDIA proprietary drivers (this may take several minutes)..."
    dnf -y install akmod-nvidia || true
    dnf -y install xorg-x11-drv-nvidia-cuda || true  # CUDA support
    dnf -y install xorg-x11-drv-nvidia-cuda-libs || true  # CUDA libraries

    # Blacklist nouveau (open-source driver conflicts with nvidia proprietary)
    echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nouveau.conf
    echo "options nouveau modeset=0" >> /etc/modprobe.d/blacklist-nouveau.conf

    # Configure dracut to include nvidia modules in initramfs
    echo 'add_drivers+=" nvidia nvidia-modeset nvidia-drm nvidia-uvm "' > /etc/dracut.conf.d/gpu-driver.conf
    echo 'force_drivers+=" nvidia nvidia-modeset nvidia-drm nvidia-uvm "' >> /etc/dracut.conf.d/gpu-driver.conf

    # Enable nvidia-persistenced for better performance
    systemctl enable nvidia-persistenced || true

    echo "NVIDIA GPU: proprietary nvidia driver configured (high performance, CUDA enabled)"
    echo "Note: Driver compilation will complete on first boot (akmod may take 2-5 minutes)"

    # ALTERNATIVE: Use open-source nouveau driver (comment out above, uncomment below)
    # Provides basic GPU support but limited performance/features - no CUDA
    #
    # echo "nouveau" > /etc/modules-load.d/nouveau.conf
    # echo 'add_drivers+=" nouveau "' > /etc/dracut.conf.d/gpu-driver.conf
    # echo "NVIDIA GPU: using open-source nouveau driver (basic support)"

elif [ "$CPU_VENDOR" = "AuthenticAMD" ] || [ "$CPU_VENDOR" = "GenuineIntel" ]; then
    echo "No discrete NVIDIA GPU detected, using integrated graphics only"
fi

# Configure dracut to include GPU drivers in initramfs and omit simpledrm
# (simpledrm is built-in on Rocky 10, can't be omitted, but we try anyway)
# Note: NVIDIA/nouveau creates its own dracut config above if detected
mkdir -p /etc/dracut.conf.d
if [ -z "$NVIDIA_GPU" ]; then
    # No NVIDIA GPU, configure AMD or Intel
    if [ "$CPU_VENDOR" = "AuthenticAMD" ]; then
        echo 'add_drivers+=" amdgpu "' > /etc/dracut.conf.d/gpu-driver.conf
    elif [ "$CPU_VENDOR" = "GenuineIntel" ]; then
        echo 'add_drivers+=" i915 "' > /etc/dracut.conf.d/gpu-driver.conf
    fi
fi
# Always try to omit simpledrm (even though it's built-in and won't work)
if [ -f /etc/dracut.conf.d/gpu-driver.conf ]; then
    echo 'omit_drivers+=" simpledrm simple-framebuffer "' >> /etc/dracut.conf.d/gpu-driver.conf
fi

# Disable simpledrm via kernel parameter (it's built-in, so must be blacklisted at boot)
# Also remove nomodeset if present (it disables ALL GPU drivers)
grubby --update-kernel=ALL --remove-args='nomodeset' || true
grubby --update-kernel=ALL --args='initcall_blacklist=simpledrm_platform_driver_init' || true

echo "GPU driver initramfs and kernel parameters configured"

# Security tools
dnf -y install \
  fail2ban \
  dnf-automatic \
  policycoreutils-python-utils \
  udica || true

# DevOps tools
dnf -y install \
  git \
  vim \
  tmux \
  htop \
  jq \
  tree \
  tar \
  unzip \
  rsync \
  sysstat \
  strace \
  tcpdump \
  nmap \
  bind-utils \
  traceroute \
  openssl \
  ansible-core \
  python3-pip \
  socat \
  iftop \
  iotop-c \
  mtr \
  open-vm-tools || true

# yq (YAML processor)
pip3 install --break-system-packages yq || true

# Node.js (needed for Claude Code and Codex)
dnf -y install nodejs npm || true

# Claude Code (Anthropic CLI)
npm install -g @anthropic-ai/claude-code || true

# Codex (OpenAI CLI)
npm install -g @openai/codex || true

# Warp terminal
rpm --import https://releases.warp.dev/linux/keys/warp.asc || true
cat > /etc/yum.repos.d/warp.repo << 'WARP'
[warpdotdev]
name=Warp terminal
baseurl=https://releases.warp.dev/linux/rpm/stable
enabled=1
gpgcheck=1
gpgkey=https://releases.warp.dev/linux/keys/warp.asc
WARP
dnf -y install warp-terminal || true
# warp-terminal RPM creates its own warpdotdev.repo — remove our duplicate
rm -f /etc/yum.repos.d/warp.repo

# --- Podman (from Rocky repos) ---
dnf -y install podman || true

# Avoid the docker-compat wrapper when also installing Docker Engine
dnf -y remove podman-docker || true

# --- Docker Engine (from Docker's RHEL repo) ---
dnf -y install dnf-plugins-core || true
# Add Docker CE repo (portable: curl the repo file directly, works on DNF4 and DNF5)
curl -fsSL https://download.docker.com/linux/rhel/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo || true
dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin || true
systemctl enable docker || true

# Docker daemon config (production-hardened)
mkdir -p /etc/docker
cat > /etc/docker/daemon.json << 'DOCKERCFG'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "3",
    "compress": "true"
  },
  "live-restore": true,
  "storage-driver": "overlay2",
  "default-address-pools": [
    {"base": "172.17.0.0/12", "size": 24}
  ],
  "userland-proxy": false,
  "no-new-privileges": true,
  "icc": false,
  "max-concurrent-downloads": 10,
  "max-concurrent-uploads": 10,
  "shutdown-timeout": 15,
  "metrics-addr": "127.0.0.1:9323",
  "features": {
    "buildkit": true
  },
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 65535,
      "Soft": 65535
    },
    "nproc": {
      "Name": "nproc",
      "Hard": 4096,
      "Soft": 4096
    }
  }
}
DOCKERCFG

# Docker systemd overrides (higher limits for busy hosts)
mkdir -p /etc/systemd/system/docker.service.d
cat > /etc/systemd/system/docker.service.d/override.conf << 'OVERRIDE'
[Service]
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
OVERRIDE

# Podman ecosystem (Netavark replaces deprecated CNI)
dnf -y install \
  podman-compose \
  podman-remote \
  buildah \
  skopeo \
  crun \
  slirp4netns \
  fuse-overlayfs \
  netavark \
  aardvark-dns \
  passt || true

# Docker tools
dnf -y install docker-ce-rootless-extras || true

# Expose Podman API socket for Docker contexts -> Podman
systemctl enable podman.socket || true

# Podman auto-update timer (checks for newer images daily)
systemctl enable podman-auto-update.timer || true

# Rootless Podman: configure subuid/subgid for adminlocal
usermod --add-subuids 100000-165535 --add-subgids 100000-165535 adminlocal || true

# Podman registry configuration
cat > /etc/containers/registries.conf << 'REGCONF'
unqualified-search-registries = ["docker.io", "quay.io", "registry.fedoraproject.org"]
short-name-mode = "permissive"
REGCONF

# Add user to docker group (takes effect after re-login)
usermod -aG docker adminlocal || true

# Passwordless sudo for adminlocal (effectively root)
echo 'adminlocal ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/adminlocal
chmod 440 /etc/sudoers.d/adminlocal

# SSH authorized key for adminlocal
mkdir -p /home/adminlocal/.ssh
echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDdUL8QmjVFLTJgG4emVsE1OohXYqRgPeGZjozveMfc7 tiha@NB001' > /home/adminlocal/.ssh/authorized_keys
chmod 700 /home/adminlocal/.ssh
chmod 600 /home/adminlocal/.ssh/authorized_keys
chown -R adminlocal:adminlocal /home/adminlocal/.ssh

# SSH hardening (password auth kept enabled for fallback login)
cat > /etc/ssh/sshd_config.d/99-hardening.conf << 'SSHD'
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication yes
KbdInteractiveAuthentication no
X11Forwarding no
MaxAuthTries 3
MaxSessions 5
ClientAliveInterval 300
ClientAliveCountMax 2
AllowUsers adminlocal
LoginGraceTime 30
SSHD

# Fail2ban for SSH brute-force protection
cat > /etc/fail2ban/jail.local << 'F2B'
[sshd]
enabled = true
banaction = nftables-allports
bantime = 3600
findtime = 600
maxretry = 3
F2B
systemctl enable fail2ban || true

# Cockpit web console (port 9090)
dnf -y install \
  cockpit \
  cockpit-storaged \
  cockpit-packagekit \
  cockpit-podman || true
systemctl enable cockpit.socket || true

# Cockpit idle timeout
mkdir -p /etc/cockpit
cat > /etc/cockpit/cockpit.conf << 'COCKPITCFG'
[Session]
IdleTimeout=15
COCKPITCFG

# Automatic security updates
cat > /etc/dnf/automatic.conf << 'DNFAUTO'
[commands]
upgrade_type = security
apply_updates = yes
random_sleep = 3600

[emitters]
emit_via = stdio
DNFAUTO
systemctl enable dnf-automatic.timer || true

# Persistent journald logging
mkdir -p /var/log/journal
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/99-persistent.conf << 'JOURNAL'
[Journal]
Storage=persistent
Compress=yes
SystemMaxUse=2G
SystemKeepFree=4G
MaxFileSec=1month
ForwardToSyslog=no
JOURNAL

# Auditd rules for Docker/Podman monitoring
mkdir -p /etc/audit/rules.d
cat > /etc/audit/rules.d/docker.rules << 'AUDIT'
-w /usr/bin/docker -p wa -k docker
-w /usr/bin/podman -p wa -k podman
-w /var/lib/docker -p wa -k docker-lib
-w /etc/docker -p wa -k docker-config
-w /etc/docker/daemon.json -p wa -k docker-daemon
-w /usr/lib/systemd/system/docker.service -p wa -k docker-service
-w /usr/lib/systemd/system/docker.socket -p wa -k docker-socket
-w /etc/containers -p wa -k podman-config
-w /usr/bin/containerd -p wa -k containerd
-w /usr/bin/runc -p wa -k runc
-w /usr/bin/crun -p wa -k crun
AUDIT
systemctl enable auditd || true

# Load kernel modules required for container networking sysctl settings
cat > /etc/modules-load.d/containers.conf << 'MODULES'
br_netfilter
nf_conntrack
overlay
MODULES

# Pre-load modules now so sysctl values can be applied during this %post
modprobe br_netfilter || true
modprobe nf_conntrack || true
modprobe overlay || true

# Ensure systemd-sysctl runs after modules are loaded on every boot
mkdir -p /etc/systemd/system/systemd-sysctl.service.d
cat > /etc/systemd/system/systemd-sysctl.service.d/after-modules.conf << 'SYSCTL_ORDER'
[Unit]
After=systemd-modules-load.service
Wants=systemd-modules-load.service
SYSCTL_ORDER

# Kernel tuning for container workloads
cat > /etc/sysctl.d/99-docker.conf << 'SYSCTL'
# Container networking
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512
fs.file-max = 2097152
vm.max_map_count = 262144
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 32768

# Connection tracking (prevents "table full" errors)
net.netfilter.nf_conntrack_max = 262144

# Security hardening
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_syncookies = 1
kernel.randomize_va_space = 2

# TCP tuning for high connection counts
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10
net.core.netdev_max_backlog = 65536

# Memory
vm.overcommit_memory = 1
vm.swappiness = 0
SYSCTL

# Weekly Docker cleanup timer
cat > /etc/systemd/system/docker-cleanup.timer << 'TIMER'
[Unit]
Description=Weekly Docker cleanup

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
TIMER

cat > /etc/systemd/system/docker-cleanup.service << 'SERVICE'
[Unit]
Description=Docker system prune
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker system prune -af --filter "until=168h"
SERVICE

systemctl enable docker-cleanup.timer || true

# Weekly Podman cleanup timer
cat > /etc/systemd/system/podman-cleanup.timer << 'TIMER'
[Unit]
Description=Weekly Podman cleanup

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
TIMER

cat > /etc/systemd/system/podman-cleanup.service << 'SERVICE'
[Unit]
Description=Podman system prune

[Service]
Type=oneshot
ExecStart=/usr/bin/podman system prune -af --filter "until=168h"
SERVICE

systemctl enable podman-cleanup.timer || true

# Rebuild initramfs with all drivers
dracut --force --regenerate-all || true

# Remove old kernels (keep max 2)
dnf remove --oldinstallonly --setopt installonly_limit=2 -y || true

# Configure and enable SNMP
cat > /etc/snmp/snmpd.conf << 'SNMPCONF'
rocommunity public
syslocation Server Room
syscontact admin@localhost
SNMPCONF
systemctl enable snmpd || true

# Force password change on first interactive (console/password) login
# Uses a profile script instead of chage -d 0, so SSH key auth is not blocked
cat > /etc/profile.d/force-passwd-change.sh << 'PWCHANGE'
if [ "$(id -un)" = "adminlocal" ] && [ -f /var/lib/force-passwd-change ] && [ -t 0 ]; then
    echo ""
    echo "============================================"
    echo "  You must change your password now."
    echo "============================================"
    echo ""
    passwd
    if [ $? -eq 0 ]; then
        sudo rm -f /var/lib/force-passwd-change
    fi
fi
PWCHANGE
chmod 644 /etc/profile.d/force-passwd-change.sh
touch /var/lib/force-passwd-change

# Disable firewalld (do NOT dnf remove — it cascades and removes fail2ban via fail2ban-firewalld dep)
# Masking prevents any package from re-enabling it; nftables is used directly by fail2ban
systemctl stop firewalld || true
systemctl disable firewalld || true
systemctl mask firewalld || true

# Clean up orphan packages
dnf autoremove -y || true

# Remove pre-baked local repo config (no longer needed after install)
rm -f /etc/yum.repos.d/prebaked-local.repo
umount /tmp/prebaked-rpms 2>/dev/null || true
rmdir /tmp/prebaked-rpms 2>/dev/null || true

# Cleanup temp files
rm -rf /tmp/*
rm -rf /var/tmp/*
%end

%pre --interpreter=/bin/bash --log=/tmp/pre-install.log
# Detect all hard drives and wipe them, EXCEPT the installer media (USB).
# Install OS on the first non-installer disk only.
# Layout: /boot/efi (512M) + /boot (2G) + / (100% LVM, no swap)
# Additional disks are wiped but left unpartitioned for later use.

# Identify the installer media so we don't wipe it.
# Supports: dd-written USB (iso9660), Ventoy (VTOYEFI label), CD/DVD (not in list-harddrives).
# PXE has no physical media so INSTALL_DEV stays empty (all disks wiped — correct).
INSTALL_DEV=""
ALL_DISKS=$(list-harddrives | awk '{print $1}' | sort)
for dev in $ALL_DISKS; do
    # Check all partitions and the whole disk for installer signatures
    for part in /dev/${dev} /dev/${dev}[0-9]* /dev/${dev}p[0-9]*; do
        [ -b "$part" ] || continue
        BLKOUT=$(blkid "$part" 2>/dev/null) || continue
        # dd-written ISO: whole disk or partition has iso9660
        if echo "$BLKOUT" | grep -qi "iso9660"; then
            INSTALL_DEV="$dev"
            echo "Detected installer media (iso9660): /dev/$dev (will NOT wipe)"
            break 2
        fi
        # Ventoy: has a partition labeled VTOYEFI or Ventoy
        if echo "$BLKOUT" | grep -qiE 'LABEL="(VTOYEFI|Ventoy)"'; then
            INSTALL_DEV="$dev"
            echo "Detected installer media (Ventoy): /dev/$dev (will NOT wipe)"
            break 2
        fi
    done
done

# Filter out the installer media from the disk list
DISKS=""
for dev in $ALL_DISKS; do
    if [ "$dev" != "$INSTALL_DEV" ]; then
        DISKS="$DISKS $dev"
    fi
done
DISKS=$(echo "$DISKS" | xargs)  # trim whitespace
FIRST=$(echo "$DISKS" | awk '{print $1}')

if [ -z "$FIRST" ]; then
    echo "ERROR: No hard drives detected (excluding installer media)!" >&2
    exit 1
fi

# Wipe existing LVM metadata (prevents "name 'rl' is already in use" on reinstall)
echo "=== Cleaning up existing LVM ==="
vgchange -an 2>/dev/null || true
for vg in $(vgs --noheadings -o vg_name 2>/dev/null); do
    echo "Removing VG: $vg"
    vgremove -ff "$vg" 2>/dev/null || true
done
for pv in $(pvs --noheadings -o pv_name 2>/dev/null); do
    echo "Removing PV: $pv"
    pvremove -ff "$pv" 2>/dev/null || true
done

# Wipe disk signatures on all detected disks (excluding installer media)
for disk in $DISKS; do
    echo "Wiping signatures on /dev/$disk"
    wipefs -af "/dev/$disk" 2>/dev/null || true
    dd if=/dev/zero of="/dev/$disk" bs=1M count=10 2>/dev/null || true
done

cat > /tmp/part-include << EOF
zerombr
clearpart --all --initlabel --disklabel=gpt
ignoredisk --only-use=$FIRST

part /boot/efi --fstype=efi --size=512 --ondisk=$FIRST
part /boot --fstype=xfs --size=2048 --ondisk=$FIRST
part pv.01 --size=1 --grow --ondisk=$FIRST
volgroup rl pv.01
logvol / --fstype=xfs --name=root --vgname=rl --percent=100
EOF

echo "=== Generated partition layout ==="
cat /tmp/part-include
echo "=== Detected disks: $DISKS (installing on: $FIRST) ==="
%end

#version=RHEL10
# Unattended Rocky Linux install + Docker Engine + Podman
#
# WARNING: This wipes ALL detected disks. OS installs on the first disk only.
# Review carefully before use.

text
reboot
eula --agreed
lang en_US.UTF-8
keyboard --xlayouts='ch(de)'
timezone Europe/Zurich --utc

# Networking (DHCP) + SSH
network --bootproto=dhcp --device=link --activate --onboot=on
services --enabled=sshd
firewall --disabled
selinux --enforcing

# Accounts
# Root locked, adminlocal gets a temporary password that must be changed at first login
rootpw --lock
user --name=adminlocal --groups=wheel --password=changeme --plaintext

# Disk: dynamic partitioning (generated by %pre, supports multiple disks)
%include /tmp/part-include

%packages
@^server-product-environment
chrony
curl
ca-certificates
dnf-plugins-core
openssh-server
net-tools
wget
bash-completion
net-snmp
net-snmp-utils
%end

%post --nochroot --interpreter=/bin/bash --log=/mnt/sysimage/root/ks-prebake.log
# Detect pre-baked RPM repo on the ISO and create a local repo config.
# Must run --nochroot because ISO mounts are not visible inside the chroot.

PREBAKE_REPO=""
# Modern Anaconda path (RHEL 9+ / Rocky 10)
for d in /run/install/sources/mount-*-cdrom; do
    if [ -d "$d/prebaked-rpms/repodata" ]; then
        PREBAKE_REPO="$d/prebaked-rpms"
        break
    fi
done
# Fallback: legacy dracut path
if [ -z "$PREBAKE_REPO" ] && [ -d "/run/install/repo/prebaked-rpms/repodata" ]; then
    PREBAKE_REPO="/run/install/repo/prebaked-rpms"
fi

if [ -n "$PREBAKE_REPO" ]; then
    echo "Found pre-baked RPM repo at ${PREBAKE_REPO}"
    # Bind-mount the repo into the chroot so the chrooted %post can access it
    mkdir -p /mnt/sysimage/tmp/prebaked-rpms
    mount --bind "$PREBAKE_REPO" /mnt/sysimage/tmp/prebaked-rpms
    cat > /mnt/sysimage/etc/yum.repos.d/prebaked-local.repo << LOCALREPO
[prebaked-local]
name=Pre-baked Local RPMs
baseurl=file:///tmp/prebaked-rpms
enabled=1
gpgcheck=0
priority=1
cost=100
LOCALREPO
    echo "Local repo bind-mounted at /mnt/sysimage/tmp/prebaked-rpms"
    echo "Repo config written — dnf will prefer cached packages"
else
    echo "No pre-baked RPM repo found — all packages will be downloaded"
fi
%end

%post --interpreter=/bin/bash --log=/root/ks-post.log
# No set -euo pipefail: non-critical failures must not abort the entire post-install

# ============================================================
# CRITICAL: User setup, updates, and core config (run first)
# ============================================================

# Full system update and upgrade
dnf -y --refresh update
dnf -y --refresh upgrade

# Configure NTP to use Swiss METAS time server
sed -i 's/^pool .*//' /etc/chrony.conf
sed -i 's/^server .*//' /etc/chrony.conf
echo 'server ntp.metas.ch iburst' >> /etc/chrony.conf
systemctl enable chronyd

# ============================================================
# PACKAGES: Install additional software
# ============================================================

# EPEL repo (needed for fail2ban and other extras)
dnf -y install epel-release

# Remove firewall early (before fail2ban install, so fail2ban-firewalld is not pulled in)
systemctl stop firewalld || true
systemctl disable firewalld || true
dnf -y remove firewalld || true

# Install firmware and drivers
dnf -y install linux-firmware dracut-config-generic
dnf -y install pciutils usbutils lshw
dnf -y groupinstall "Hardware Monitoring Utilities" || true

# Security tools
dnf -y install \
  fail2ban \
  dnf-automatic \
  policycoreutils-python-utils \
  udica || true

# DevOps tools
dnf -y install \
  git \
  vim \
  tmux \
  htop \
  jq \
  tree \
  tar \
  unzip \
  rsync \
  sysstat \
  strace \
  tcpdump \
  nmap \
  bind-utils \
  traceroute \
  openssl \
  ansible-core \
  python3-pip \
  socat \
  iftop \
  iotop \
  mtr \
  open-vm-tools || true

# yq (YAML processor)
pip3 install --break-system-packages yq || true

# Node.js (needed for Claude Code and Codex)
dnf -y install nodejs npm || true

# Claude Code (Anthropic CLI)
npm install -g @anthropic-ai/claude-code || true

# Codex (OpenAI CLI)
npm install -g @openai/codex || true

# Warp terminal
rpm --import https://releases.warp.dev/linux/keys/warp.asc || true
cat > /etc/yum.repos.d/warp.repo << 'WARP'
[warpdotdev]
name=Warp terminal
baseurl=https://releases.warp.dev/linux/rpm/stable
enabled=1
gpgcheck=1
gpgkey=https://releases.warp.dev/linux/keys/warp.asc
WARP
dnf -y install warp-terminal || true

# --- Podman (from Rocky repos) ---
dnf -y install podman

# Avoid the docker-compat wrapper when also installing Docker Engine
dnf -y remove podman-docker || true

# --- Docker Engine (from Docker's RHEL repo) ---
dnf -y install dnf-plugins-core
dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo
dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl enable docker

# Docker daemon config (production-hardened)
mkdir -p /etc/docker
cat > /etc/docker/daemon.json << 'DOCKERCFG'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "3",
    "compress": "true"
  },
  "live-restore": true,
  "storage-driver": "overlay2",
  "default-address-pools": [
    {"base": "172.17.0.0/12", "size": 24}
  ],
  "userland-proxy": false,
  "no-new-privileges": true,
  "icc": false,
  "exec-opts": ["native.cgroupdriver=systemd"],
  "max-concurrent-downloads": 10,
  "max-concurrent-uploads": 10,
  "shutdown-timeout": 15,
  "metrics-addr": "127.0.0.1:9323",
  "features": {
    "buildkit": true
  },
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 65535,
      "Soft": 65535
    },
    "nproc": {
      "Name": "nproc",
      "Hard": 4096,
      "Soft": 4096
    }
  }
}
DOCKERCFG

# Docker systemd overrides (higher limits for busy hosts)
mkdir -p /etc/systemd/system/docker.service.d
cat > /etc/systemd/system/docker.service.d/override.conf << 'OVERRIDE'
[Service]
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
OVERRIDE

# Podman ecosystem (Netavark replaces deprecated CNI)
dnf -y install \
  podman-compose \
  podman-remote \
  buildah \
  skopeo \
  crun \
  slirp4netns \
  fuse-overlayfs \
  netavark \
  aardvark-dns \
  passt || true

# skopeo (container image inspection tool)
dnf -y install skopeo || true

# Docker tools
dnf -y install docker-ce-rootless-extras || true

# Expose Podman API socket for Docker contexts -> Podman
systemctl enable podman.socket || true

# Podman auto-update timer (checks for newer images daily)
systemctl enable podman-auto-update.timer || true

# Rootless Podman: configure subuid/subgid for adminlocal
usermod --add-subuids 100000-165535 --add-subgids 100000-165535 adminlocal

# Podman registry configuration
cat > /etc/containers/registries.conf << 'REGCONF'
unqualified-search-registries = ["docker.io", "quay.io", "registry.fedoraproject.org"]
short-name-mode = "permissive"
REGCONF

# Add user to docker group (takes effect after re-login)
usermod -aG docker adminlocal || true

# Passwordless sudo for adminlocal (effectively root)
echo 'adminlocal ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/adminlocal
chmod 440 /etc/sudoers.d/adminlocal

# SSH authorized key for adminlocal
mkdir -p /home/adminlocal/.ssh
echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDdUL8QmjVFLTJgG4emVsE1OohXYqRgPeGZjozveMfc7 tiha@NB001' > /home/adminlocal/.ssh/authorized_keys
chmod 700 /home/adminlocal/.ssh
chmod 600 /home/adminlocal/.ssh/authorized_keys
chown -R adminlocal:adminlocal /home/adminlocal/.ssh

# SSH hardening (password auth kept enabled for fallback login)
cat > /etc/ssh/sshd_config.d/99-hardening.conf << 'SSHD'
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication yes
KbdInteractiveAuthentication no
X11Forwarding no
MaxAuthTries 3
MaxSessions 5
ClientAliveInterval 300
ClientAliveCountMax 2
AllowUsers adminlocal
LoginGraceTime 30
SSHD

# Fail2ban for SSH brute-force protection
cat > /etc/fail2ban/jail.local << 'F2B'
[sshd]
enabled = true
bantime = 3600
findtime = 600
maxretry = 3
F2B
systemctl enable fail2ban

# Cockpit web console (port 9090)
dnf -y install \
  cockpit \
  cockpit-storaged \
  cockpit-networkmanager \
  cockpit-packagekit \
  cockpit-podman \
  cockpit-selinux \
  cockpit-sosreport || true
systemctl enable cockpit.socket

# Cockpit idle timeout
mkdir -p /etc/cockpit
cat > /etc/cockpit/cockpit.conf << 'COCKPITCFG'
[Session]
IdleTimeout=15
COCKPITCFG

# Automatic security updates
cat > /etc/dnf/automatic.conf << 'DNFAUTO'
[commands]
upgrade_type = security
apply_updates = yes
random_sleep = 3600

[emitters]
emit_via = stdio
DNFAUTO
systemctl enable dnf-automatic.timer

# Persistent journald logging
mkdir -p /var/log/journal
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/99-persistent.conf << 'JOURNAL'
[Journal]
Storage=persistent
Compress=yes
SystemMaxUse=2G
SystemKeepFree=4G
MaxFileSec=1month
ForwardToSyslog=no
JOURNAL

# Auditd rules for Docker/Podman monitoring
mkdir -p /etc/audit/rules.d
cat > /etc/audit/rules.d/docker.rules << 'AUDIT'
-w /usr/bin/docker -p wa -k docker
-w /usr/bin/podman -p wa -k podman
-w /var/lib/docker -p wa -k docker-lib
-w /etc/docker -p wa -k docker-config
-w /etc/docker/daemon.json -p wa -k docker-daemon
-w /usr/lib/systemd/system/docker.service -p wa -k docker-service
-w /usr/lib/systemd/system/docker.socket -p wa -k docker-socket
-w /etc/containers -p wa -k podman-config
-w /usr/bin/containerd -p wa -k containerd
-w /usr/bin/runc -p wa -k runc
-w /usr/bin/crun -p wa -k crun
AUDIT
systemctl enable auditd

# Kernel tuning for container workloads
cat > /etc/sysctl.d/99-docker.conf << 'SYSCTL'
# Container networking
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512
fs.file-max = 2097152
vm.max_map_count = 262144
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 32768

# Connection tracking (prevents "table full" errors)
net.netfilter.nf_conntrack_max = 262144

# Security hardening
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_syncookies = 1
kernel.randomize_va_space = 2

# TCP tuning for high connection counts
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10
net.core.netdev_max_backlog = 65536

# Memory
vm.overcommit_memory = 1
vm.swappiness = 10
SYSCTL

# Weekly Docker cleanup timer
cat > /etc/systemd/system/docker-cleanup.timer << 'TIMER'
[Unit]
Description=Weekly Docker cleanup

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
TIMER

cat > /etc/systemd/system/docker-cleanup.service << 'SERVICE'
[Unit]
Description=Docker system prune
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker system prune -af --filter "until=168h"
SERVICE

systemctl enable docker-cleanup.timer || true

# Weekly Podman cleanup timer
cat > /etc/systemd/system/podman-cleanup.timer << 'TIMER'
[Unit]
Description=Weekly Podman cleanup

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
TIMER

cat > /etc/systemd/system/podman-cleanup.service << 'SERVICE'
[Unit]
Description=Podman system prune

[Service]
Type=oneshot
ExecStart=/usr/bin/podman system prune -af --filter "until=168h"
SERVICE

systemctl enable podman-cleanup.timer || true

# Rebuild initramfs with all drivers
dracut --force --regenerate-all || true

# Remove old kernels
dnf remove --oldinstallonly -y || true
dnf remove --oldinstallonly --setopt installonly_limit=2 -y || true

# Configure and enable SNMP
echo "rocommunity public" >> /etc/snmp/snmpd.conf
systemctl enable snmpd

# Force password change on first interactive (console/password) login
# Uses a profile script instead of chage -d 0, so SSH key auth is not blocked
cat > /etc/profile.d/force-passwd-change.sh << 'PWCHANGE'
if [ "$(id -un)" = "adminlocal" ] && [ -f /var/lib/force-passwd-change ]; then
    echo ""
    echo "============================================"
    echo "  You must change your password now."
    echo "============================================"
    echo ""
    passwd
    if [ $? -eq 0 ]; then
        sudo rm -f /var/lib/force-passwd-change
    fi
fi
PWCHANGE
chmod 644 /etc/profile.d/force-passwd-change.sh
touch /var/lib/force-passwd-change

# Remove pre-baked local repo config (no longer needed after install)
rm -f /etc/yum.repos.d/prebaked-local.repo
umount /tmp/prebaked-rpms 2>/dev/null || true
rmdir /tmp/prebaked-rpms 2>/dev/null || true

# Cleanup temp files
rm -rf /tmp/*
rm -rf /var/tmp/*
%end

%pre --interpreter=/bin/bash --log=/tmp/pre-install.log
# Detect all hard drives (list-harddrives auto-excludes the installer media).
# Wipe everything, install OS on the first disk only.
# Layout: /boot/efi (512M) + /boot (2G) + / (100% LVM, no swap)
# Additional disks are wiped but left unpartitioned for later use.

DISKS=$(list-harddrives | awk '{print $1}' | sort)
FIRST=$(echo "$DISKS" | head -1)

if [ -z "$FIRST" ]; then
    echo "ERROR: No hard drives detected!" >&2
    exit 1
fi

cat > /tmp/part-include << EOF
zerombr
clearpart --all --initlabel --disklabel=gpt
ignoredisk --only-use=$FIRST

part /boot/efi --fstype=efi --size=512 --ondisk=$FIRST
part /boot --fstype=xfs --size=2048 --ondisk=$FIRST
part pv.01 --size=1 --grow --ondisk=$FIRST
volgroup rl pv.01
logvol / --fstype=xfs --name=root --vgname=rl --percent=100
EOF

echo "=== Generated partition layout ==="
cat /tmp/part-include
echo "=== Detected disks: $DISKS (installing on: $FIRST) ==="
%end
